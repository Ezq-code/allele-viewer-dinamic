{% extends "index.html" %}
{% load static %}
{% load i18n %}
{% block head-extra %}

    <link rel="stylesheet" href="{% static 'assets/dist/css/timeline-timedimension/style.css' %}"/>
    <link rel="stylesheet" href="{% static 'assets/dist/css/timeline-timedimension/leaflet.css' %}"/>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.js' %}"></script>

    <link rel="stylesheet" href="{% static 'assets/dist/css/timeline-timedimension/default.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'assets/dist/css/timeline-timedimension/Control.FullScreen.min.css' %}"/>

    <link rel="stylesheet"
          href="{% static 'assets/dist/css/timeline-timedimension/leaflet.timedimension.control.css' %}"/>

    <link rel="stylesheet" href="{% static 'assets/dist/css/map-style.css' %}"/>

    <script src="{% static 'assets/dist/js/timeline-timedimension/Control.FullScreen.min.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/NonTiledLayer.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/iso8601.min.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet-omnivore.min.js' %}"></script>

    <script src="{% static 'assets/dist/js/timeline-timedimension/highlight.min.js' %}"></script>

    <script src="{% static 'assets/dist/Leaflet/libs/leaflet-src.js' %}"></script>
    <link rel="stylesheet" href="{% static 'assets/dist/Leaflet/libs/leaflet.css' %}"/>
    <script src="{% static 'assets/dist/Leaflet/src/Leaflet.draw.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/Leaflet.Draw.Event.js' %}"></script>
    <link rel="stylesheet" href="{% static 'assets/dist/Leaflet/src/leaflet.draw.css' %}"/>
    <script src="{% static 'assets/dist/Leaflet/src/Toolbar.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/Tooltip.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/ext/GeometryUtil.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/ext/LatLngUtil.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/ext/LineUtil.Intersect.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/ext/Polygon.Intersect.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/ext/Polyline.Intersect.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/ext/TouchEvents.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/DrawToolbar.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Feature.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.SimpleShape.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Polyline.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Marker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Circle.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.CircleMarker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Polygon.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Rectangle.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/EditToolbar.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/EditToolbar.Edit.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/EditToolbar.Delete.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/Control.Draw.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Poly.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.SimpleShape.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Rectangle.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Marker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.CircleMarker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Circle.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/DrawToolbar.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Feature.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.SimpleShape.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Polyline.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Marker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Circle.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.CircleMarker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Polygon.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/draw/handler/Draw.Rectangle.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/EditToolbar.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/EditToolbar.Edit.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/EditToolbar.Delete.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/Control.Draw.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Poly.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.SimpleShape.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Rectangle.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Marker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.CircleMarker.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/src/edit/handler/Edit.Circle.js' %}"></script>
    <!--End Draw Ref-->
    <link rel="stylesheet" href="{% static 'assets/dist/Leaflet/lib/MarkerCluster.css' %}"/>
    <link rel="stylesheet" href="{% static 'assets/dist/Leaflet/lib/MarkerCluster.Default.css' %}"/>
    <script src="{% static 'assets/dist/Leaflet/lib/leaflet.markercluster-src.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/lib/jquery.js' %}"></script>
    <link rel="stylesheet" href="{% static 'assets/dist/Leaflet/leaflet.shapefile-gh-pages/gh-pages.css' %}"/>
    <script src="{% static 'assets/dist/Leaflet/leaflet.shapefile-gh-pages/catiline.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/Leaflet.timeline/leaflet.timeline.js' %}"></script>
    <script src="{% static 'assets/dist/Leaflet/leaflet.shapefile-gh-pages/leaflet.shpfile.js' %}"></script>
    <link rel="stylesheet" href="{% static 'assets/dist/css/map-style.css' %}"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">

    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.timedimension.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.timedimension.util.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.timedimension.layer.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.timedimension.layer.wms.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.timedimension.layer.geojson.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.timedimension.player.js' %}"></script>
    <script src="{% static 'assets/dist/js/timeline-timedimension/leaflet.timedimension.control.js' %}"></script>
    <link rel="stylesheet" href="{% static 'assets/dist/css/driver.css' %}"/>
    <script src="{% static 'assets/dist/js/driver.js' %}"></script>


{% endblock %}

{% block content %}
    <!-- Modal para seleccionar el tipo de evento -->
    <div class="modal fade" id="modalTypeEventMarker" tabindex="-1" role="dialog"
         aria-labelledby="modalTypeEventMarkerLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTypeEventMarkerLabel">Select Event</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="event-type-form">
                        <div class="form-group">
                            <label for="eventoModal">Event:</label>
                            <select required class="form-control" id="eventoModal">
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btnok btn-primary" id="save-event-type">OK</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal para la creaciÃ³n del marcador -->
    <div class="modal fade" id="modalMarker" tabindex="-1" role="dialog" aria-labelledby="modalMarkerLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMarkerLabel">Mark Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="modal-form"> {% csrf_token %}
                        <div class="form-group">
                            <label for="evento">Event:</label>
                            <select class="form-control" id="evento"></select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="latitudid">Latitude:</label>
                                    <input class="form-control" type="text" id="latitudid" name="latitud" disabled>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="longitudid">Longitude:</label>
                                    <input class="form-control" type="text" id="longitudid" name="longitud" disabled>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="BtnSaveMarker" type="submit" class="btnok btn-primary">Save</button>
                    <button id="BtnClose" type="button" class="btnok btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar con el panel derecho que muestra el listado de las migraciones cronolÃ³gicamente -->
    <aside id="info" class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
        <div class="p-3 d-flex flex-column">
            <div class="d-flex align-items-center">
                <h6 class="mr-3">CYP2D6 Alleles-Expansions</h6>
                <a class="nav-link ml-auto" data-widget="control-sidebar" data-controlsidebar-slide="true" href="#"
                   role="button">
                    <i class="fas fa-times"></i>
                </a>
            </div>
            <ul id="displayed-list" style="font-size:11px;"></ul>
        </div>
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header" style="padding-top: 3px; padding-bottom: 3px;">
        </section>
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header" style="padding-top: 0.50rem; padding-bottom: 0.50rem;">
                                <h3 class="card-title">Map - CYP2D6 Alleles-Expansions</h3>
                                <div class="card-tools">
                                    <div class="d-inline-block">
                                        <select class="form-control form-control-sm" name="regionTimeLine"
                                                id="regionTimeLine" style="width:140px;">
                                            <option value="All the World">All the World</option>
                                            <option value="Africa">Africa</option>
                                            <option value="Western Asia">Western Asia</option>
                                            <option value="Eastern Asia">Eastern Asia</option>
                                            <option value="Europe">Europe</option>
                                            <option value="Oceania">Oceania</option>
                                            <option value="North America">North America</option>
                                            <option value="Latin America & Carib">Latin America & Carib</option>
                                        </select>

                                    </div>

                                    <div class="d-inline-block">
                                        <button class="btnok btn-primary btn-sm border-right" id="btreload">Load
                                        </button>
                                    </div>
                                    <div class="d-inline-block">
                                        <button class="btnok btn-success btn-sm border-right" id="legend" hidden="true"
                                        >Legend
                                        </button>
                                    </div>
                                    <div class="d-inline-block">
                                        <button type="button" class="btnok btn-sm btn-toggle-legend btn-danger"
                                                title="Show/Hide Legend" id="toggleLegendPanel">
                                            <i class="fas fa-book-open"></i>
                                        </button>
                                        <button id="toggleWalking" type="button" class="btnok btn-sm btn-secondary"
                                                title="CYP2D6 Alleles-Expansions"
                                                data-widget="control-sidebar"
                                                data-controlsidebar-slide="true">
                                            <i class="fas fa-walking"></i>
                                        </button>
                                        <div class="d-inline-block">
                                            <select class="form-control form-control-sm" name="timeRange" id="timeRange"
                                                    disabled>
                                                <option value="-15000/2025">From 15000 YBP to year 2025</option>
                                                <option value="-1800000/-804400">Homo Erectus Migrations</option>
                                                <option value="-700000/-190539">Heidelbergensis Migrations</option>
                                                <option value="-69000/-15000" selected>Homo Sapiens Migrations</option>
                                                <option value="-130000/-115000">-130000 to -115000 High Temperature
                                                </option>
                                            </select>
                                        </div>
                                        <button type="button" class="btnok btn-sm btn-toggle-panel btn-warning"
                                                title="Time Range Selection" id="toggleTimeRangePanel">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <div class="d-inline-block">
                                            <button type="button" class="btnok btn-sm btn-info" id="startTourBtn"
                                                    title="Iniciar Tour Guiado">
                                                <i class="fas fa-question-circle"></i> Help
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body"
                                 style="padding-top: 0.70rem; padding-bottom: 0.70rem; padding-left: 2rem; padding-right: 2rem;">
                                <div class="right-sidebar d-flex">
                                    <div id="map" class="map-container col-lg-12"></div>
                                    <div id="timeRangeMigraions" class="time-range-container">
                                        <h5>Time Range Selection</h5>
                                        <select class="custom-multiselect" size="5">
                                            <option value="-15000/2025">From 15000 YBP to year 2025</option>
                                            <option value="-1800000/-804400">Homo Erectus Migrations</option>
                                            <option value="-700000/-190539">Heidelbergensis Migrations</option>
                                            <option value="-69000/-15000" selected>Homo Sapiens Migrations</option>
                                            <option value="-130000/-115000">-130000 to -115000 High Temperature</option>
                                        </select>
                                    </div>
                                </div>

                                <script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>
                                <script>
                                    // DuraciÃ³n fija para el loader en milisegundos (10 segundos)
                                    const LOADER_DURATION = 15000;
                                    // 1. Mostrar el loader en cuanto el DOM estÃ© listo.
                                    // document.addEventListener('DOMContentLoaded', function () {
                                    Swal.fire({
                                        title: 'Updating TimeLine Data...',
                                        html: 'Please wait a few seconds...',
                                        timer: LOADER_DURATION,
                                        timerProgressBar: true, // barra de progreso del tiempo
                                        allowOutsideClick: false,
                                        allowEscapeKey: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                                    });

                                    //});

                                </script>

                                <script>
                                    var importUrlPath = "{% static 'assets/dist/Leaflet/leaflet.shapefile-gh-pages/shp.js' %}";
                                </script>

                                <!-- codigo javascript para cargar archivos de tipo shape -->
                                <script src="{% static 'assets/dist/js/map-load-shape.js' %}"></script>

                                <!-- Script para controlar el panel deslizante -->
                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const toggleButton = document.getElementById('toggleTimeRangePanel');
                                        const timeRangePanel = document.getElementById('timeRangeMigraions');
                                        const mapContainer = document.getElementById('map');

                                        toggleButton.addEventListener('click', function () {
                                            // Alternar la clase 'open' en el panel
                                            timeRangePanel.classList.toggle('open');

                                            // Alternar la clase 'panel-open' en el mapa para el ancho
                                            mapContainer.classList.toggle('panel-open');

                                            // Actualizar el mapa cuando cambie el tamaÃ±o del contenedor
                                            setTimeout(function () {
                                                if (typeof map !== 'undefined') {
                                                    map.invalidateSize();
                                                }
                                            }, 300);
                                        });
                                    });
                                </script>

                                <script>

                                    if (!sessionStorage.getItem('inicializado')) {
                                        // CÃ³digo que solo se ejecuta en la primera carga
                                        sessionStorage.setItem('beginIntervalsesion', -69000);
                                        sessionStorage.setItem('endIntervalsesion', -15000);
                                        sessionStorage.setItem('durationSesion', 54000);
                                        sessionStorage.setItem('lat', 5);
                                        sessionStorage.setItem('long', 155);
                                        sessionStorage.setItem('zoom', 2.1);
                                        sessionStorage.setItem('timeRange', '-69000/-15000');
                                        sessionStorage.setItem('timeRangeMigraions', '-69000/-15000');
                                        sessionStorage.setItem('region', 'All the World');
                                        sessionStorage.setItem('inicializado', 'true');
                                        sessionStorage.setItem('timedelayice', 'PT9S');
                                        sessionStorage.setItem('timedelayland', 'PT9S');
                                    }

                                    var timeRange = sessionStorage.getItem('timeRange');

                                    var timeRangeIni = document.getElementById("timeRange");
                                    var regionTimeLineIni = document.getElementById("regionTimeLine");
                                    var timeRangeMigraionsIni = document.getElementById("timeRangeMigraions");
                                    var timeLineTimeDelayIce = sessionStorage.getItem('timedelayice');
                                    var timeLineTimeDelayLand = sessionStorage.getItem('timedelayland');
                                    timeRangeIni.value = sessionStorage.getItem('timeRange');
                                    regionTimeLineIni.value = sessionStorage.getItem('region');
                                    timeRangeMigraionsIni.value = sessionStorage.getItem('timeRange');
                                    var timeOld = sessionStorage.getItem('beginIntervalsesion');
                                    var currentTimeAnt = -1810000;
                                    var migrationlist = new Array();

                                    // Capa Base con mapa polÃ­tico
                                    var countriesLayers = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"; 
                                    var osmAttrib = "CYP2D6 Alleles-Expansions";
                                    var osmcountriesLayers = L.tileLayer(countriesLayers, {
                                        minZoom: 1,
                                        attribution: osmAttrib,
                                    });

                                    // Capa Base con mapa satelital
                                    var satelitalLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                                        minZoom: 1,
                                        attribution: 'Allele-Viewer'
                                    });

                                    // Capa Base con mapa de los ocÃ©anos
                                    var oceanLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
                                        minZoom: 1,
                                        attribution: 'Allele-Viewer'
                                    });

                                    // Capa Base con mapa del Ãºltimo glacial mÃ¡ximo
                                    var LandLGMShapefile = new L.Shapefile("{% static 'assets/dist/Leaflet/Last-Glacial-Maximum/landmassLGMPolygon2.zip' %}", {
                                        style: function (feature) {
                                            return {
                                                color: '#2D2',
                                                fillColor: '#2D2',
                                                fillOpacity: 0.5,
                                                weight: 2,
                                                opacity: 1,
                                            };
                                        }
                                    });


                                    if (timeRange === "-12000/2025") {

                                        // CreaciÃ³n de la variable del Mapa
                                        var map = L.map("map", {
                                            layers: [satelitalLayer],
                                            center: new L.LatLng(10, 120),//new L.LatLng(-3, 20),
                                            zoom: 2,//4,
                                            maxBounds: [
                                                [90, -50],
                                                [-90, 335],
                                            ],
                                        });

                                        map.setView(new L.LatLng(parseInt(sessionStorage.getItem('lat')), parseInt(sessionStorage.getItem('long'))), parseInt(sessionStorage.getItem('zoom')));

                                        // Inicializar el filtro de eventos
                                        // Capa de las marcas
                                        markerLayer = new L.featureGroup().addTo(map);
                                        var markerMigrationPointLayer = new L.featureGroup().addTo(map);
                                        var labeled = false;
                                        //var eventFilter = new EventTimeFilter(map, null, timeRange);
                                    } else {
                                        // FunciÃ³n para ajustar el mapa segÃºn el tamaÃ±o de la pantalla
                                        if (window.innerWidth <= 768) { // Consideramos pantallas pequeÃ±as (por ejemplo, telÃ©fonos)
                                            var map = L.map('map', {
                                                layers: [satelitalLayer], //[osmcountriesLayers],
                                                zoom: 2,//14,],
                                                fullscreenControl: true,
                                                timeDimension: true,
                                                center: new L.LatLng(10, 20) //[36.72, -4.43]
                                            });
                                        } else {
                                            var map = L.map('map', {
                                                layers: [satelitalLayer], //[osmcountriesLayers],
                                                zoomSnap: 0.1,
                                                zoom: 2.1,//14,],
                                                fullscreenControl: true,
                                                timeDimension: true,
                                                center: new L.LatLng(5, 155), //[36.72, -4.43]
                                            });
                                        }

                                        L.Control.TimeDimensionCustom = L.Control.TimeDimension.extend({
                                            _getDisplayDateFormat: function (date) {
                                                return date.getTime() + " Years Before"; //Date.parse(date); //date.getFullYear();
                                            }
                                        });
                                        var timeDimensionControl = new L.Control.TimeDimensionCustom({
                                            displayTime: false,
                                            timeSliderDragUpdate: true,
                                            loopButton: true,
                                            //speed: 60,
                                            minSpeed: 0,
                                            maxSpeed: 60,
                                            speedStep: 1,
                                            speedSlider: true,
                                            autoPlay: false,
                                            playerOptions: {
                                                transitionTime: 50, // Velocidad INICIAL (ms entre pasos)
                                                minTransitionTime: 16, // 60 FPS (1000ms/60 â 16ms)
                                                maxTransitionTime: 50, // 20 FPS (1000ms/20 = 50ms)
                                                loop: false
                                                // buffer: 1,
                                                // minBufferReady: -1
                                            }

                                        });

                                        map.addControl(timeDimensionControl);


// Inicializar el filtro de eventos                                    
// Capa de las marcas
                                        markerLayer = new L.featureGroup().addTo(map);
                                        var markerMigrationPointLayer = new L.featureGroup().addTo(map);
                                        var labeled = false;

// Get the TimeDimension instance from the map
                                        var timeDimension = map.timeDimension;

// Configurar el selector de rangos
// Configurar el selector de rangos// LOS CAMBIOS FUERON AQUI
                                        var timeRangeSelect = document.getElementById('timeRangeMigraions').querySelector('select');
                                        if (timeRangeSelect) {
                                            // Si no hay valor en sessionStorage, usar el valor de la primera opciÃ³n por defecto
                                            if (!sessionStorage.getItem('timeRange')) {
                                                timeRange = timeRangeSelect.options[0].value;
                                                sessionStorage.setItem('timeRange', timeRange);
                                            }
                                            // Remover selected de todas las opciones primero
                                            Array.from(timeRangeSelect.options).forEach(option => {
                                                option.removeAttribute('selected');
                                            });
                                            // Establecer la opciÃ³n correcta como selected
                                            timeRangeSelect.value = timeRange;
                                            timeRangeSelect.options[timeRangeSelect.selectedIndex].setAttribute('selected', 'selected');

                                            timeRangeSelect.addEventListener('change', function (e) {
                                                var newRange = e.target.value;
                                                sessionStorage.setItem('timeRange', newRange);
                                                location.reload();
                                            });
                                        }

                                        //Capa de marcadores por defecto apagada
                                        markerLayer.remove();

                                    }

                                    var timelinetimedimension = "{% static 'assets/dist/Leaflet/Leaflet.timeline/timeline-timedimension-homosapiens.geojson' %}";
                                    var timelinetimedimensionHomoSapiens = "{% static 'assets/dist/Leaflet/Leaflet.timeline/timeline-timedimension-homosapiens.geojson' %}";
                                    var timelinetimedimensionHomoHeidelBergensis = "{% static 'assets/dist/Leaflet/Leaflet.timeline/timeline-timedimension-homoheidelbergensis.geojson' %}";
                                    var timelinetimedimensionHomoHerectus = "{% static 'assets/dist/Leaflet/Leaflet.timeline/timeline-timedimension-homoherectus.geojson' %}";
                                    var timelinetimedimensiontimeline_130000_115000_HighTemperature = "{% static 'assets/dist/Leaflet/Leaflet.timeline/timeline-timedimension-130000-115000-High-Temperature.geojson' %}";
                                    var timelinetimedimensiontimeline_15000_2025 = "{% static 'assets/dist/Leaflet/Leaflet.timeline/timeline-timedimension-15000-2025.geojson' %}";

                                    var iconUrlpath = "{% static 'assets/dist/Leaflet/marker_black.png' %}";
                                    var iconUrlpathDestinationMigration = "{% static 'assets/dist/Leaflet/primitive-man4.png' %}";
                                    var iconUrlpathDestinationMigrationHomoHeidel = "{% static 'assets/dist/Leaflet/primitive-man1.png' %}";
                                    var iconUrlpathDestinationMigrationHomoHerectus = "{% static 'assets/dist/Leaflet/primitive-man25.png' %}";

                                    // FunciÃ³n para crear la leyenda deslizante
                                    function createSlidingLegend() {
                                        var legendContainer = document.createElement('div');
                                        legendContainer.id = 'legendContainer';
                                        legendContainer.className = 'legend-container';

                                        // Crear el contenido de la leyenda usando tu funciÃ³n existente
                                        var legendDiv = createLegendContent();
                                        legendContainer.appendChild(legendDiv);

                                        return legendContainer;
                                    }

                                    // FunciÃ³n que extrae solo el contenido HTML de tu leyenda original
                                    function createLegendContent() {
                                        var div = document.createElement("div");
                                        div.className = "legend";
                                        div.innerHTML = "<h4>Legend</h4>";

                                        // Contenedor principal de dos columnas
                                        var columnsContainer = document.createElement("div");
                                        columnsContainer.className = "legend-columns-container";
                                        div.appendChild(columnsContainer);

                                        // PRIMERA COLUMNA
                                        var firstColumn = document.createElement("div");
                                        firstColumn.className = "legend-column";
                                        columnsContainer.appendChild(firstColumn);

                                        // SecciÃ³n: Especies Humanas
                                        var speciesSection = document.createElement("div");
                                        speciesSection.className = "legend-section";
                                        speciesSection.innerHTML = '<h5>Humans, Glacials and Land</h5>' +
                                            '<div class="legend-item"><div class="species-container"><i class="icon" style="background-image: url({% static 'assets/dist/Leaflet/primitive-man1.png' %});background-repeat: no-repeat;"></i><span class="color-line horizontal" style="background: #FF5733"></span></div><span>Homo Erectus</span></div>' +
                                            '<div class="legend-item"><div class="species-container"><i class="icon" style="background-image: url({% static 'assets/dist/Leaflet/primitive-man1.png' %});background-repeat: no-repeat;"></i><span class="color-line horizontal" style="background: #3398FF"></span></div><span>Homo Heidelbergensis</span></div>' +
                                            '<div class="legend-item"><div class="species-container"><i class="icon" style="background-image: url({% static 'assets/dist/Leaflet/primitive-man1.png' %});background-repeat: no-repeat;"></i><span class="color-line horizontal" style="background: #33FF57"></span></div><span>Homo Sapiens</span></div>' +
                                            '<div class="legend-item"><i style="background: #FFFFFF; border: 1px solid #999"></i><span>Glacials</span></div>' +
                                            '<div class="legend-item"><i style="background: #676a4a; border: 1px solid #999"></i><span>Land Emerge</span></div>';
                                        firstColumn.appendChild(speciesSection);

                                        // Separador
                                        firstColumn.innerHTML += '<hr class="legend-separator">';

                                        // SecciÃ³n: Tipos de Eventos (desde Django)
                                        var eventsSection = document.createElement("div");
                                        eventsSection.className = "legend-section";
                                        eventsSection.innerHTML = '<h5>Event Types</h5>';
                                        firstColumn.appendChild(eventsSection);

                                        // AquÃ­ agregamos los tipos de eventos desde Django
                                        {% for event_type in events_types %}
                                            eventsSection.innerHTML += '<div class="legend-item"><i class="icon" style="background-image: url({{ event_type.icon.url }});background-repeat: no-repeat;"></i><span>{{ event_type.name }}</span></div>';
                                        {% endfor %}

                                        // SEGUNDA COLUMNA
                                        var secondColumn = document.createElement("div");
                                        secondColumn.className = "legend-column";
                                        columnsContainer.appendChild(secondColumn);

                                        // SecciÃ³n: PoblaciÃ³n
                                        var populationSection = document.createElement("div");
                                        populationSection.className = "legend-section";
                                        populationSection.innerHTML = '<h5>Population</h5>' +
                                            '<div class="legend-item"><i style="background: #CCFFEE"></i><span>1 to 500 people</span></div>' +
                                            '<div class="legend-item"><i style="background: #B3FFE5"></i><span>501 to 1,000 people</span></div>' +
                                            '<div class="legend-item"><i style="background: #99FFDD"></i><span>1,000 to 5,000 people</span></div>' +
                                            '<div class="legend-item"><i style="background: #80FFD4"></i><span>5,000 to 10,000 people</span></div>' +
                                            '<div class="legend-item"><i style="background: #66FFCC"></i><span>10,000 to 50,000 people</span></div>' +
                                            '<div class="legend-item"><i style="background: #33FFBB"></i><span>50,000 to 100,000 people</span></div>' +
                                            '<div class="legend-item"><i style="background: #19FFB2"></i><span>100,000 to 500,000 people</span></div>' +
                                            '<div class="legend-item"><i style="background: #00FFAA"></i><span>500,000 to 1 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #00E699"></i><span>1 to 5 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #00CC88"></i><span>5 to 10 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #00B377"></i><span>10 to 50 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #009966"></i><span>50 to 100 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #008055"></i><span>100 to 500 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #006644"></i><span>500 to 1,000 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #004D33"></i><span>1,000 to 2,000 million people</span></div>' +
                                            '<div class="legend-item"><i style="background: #003322"></i><span>More than 2,000 million people</span></div>';
                                        secondColumn.appendChild(populationSection);

                                        return div;
                                    }

                                    // Control para mostrar/ocultar la leyenda
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const toggleLegendButton = document.getElementById('toggleLegendPanel');
                                        const mapContainer = document.getElementById('map');

                                        // Crear y agregar el contenedor de leyenda
                                        const legendContainer = createSlidingLegend();
                                        document.querySelector('.right-sidebar').appendChild(legendContainer);

                                        toggleLegendButton.addEventListener('click', function () {
                                            // Alternar la clase 'open' en el panel de leyenda
                                            legendContainer.classList.toggle('open');

                                            // Alternar la clase 'legend-open' en el mapa para el ancho
                                            mapContainer.classList.toggle('legend-open');

                                            // Actualizar el mapa cuando cambie el tamaÃ±o del contenedor
                                            setTimeout(function () {
                                                if (typeof map !== 'undefined') {
                                                    map.invalidateSize();
                                                }
                                            }, 300);
                                        });

                                    });

                                </script>
                                <!-- Script que almacena en la variable authenticated el estado del usuario, si esta autenticado o no -->
                                <script>
                                    var authenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
                                </script>
                                <!-- cÃ³digo javasript para almacenar time stamp -->
                                <!-- <script src="{% static 'assets/dist/js/map-array-time-stamp.js' %}"></script> -->
                                <!-- cÃ³digo javascript para cargar el color dada la cantidad de habitantes -->
                                <script src="{% static 'assets/dist/js/map-function-colors.js' %}"></script>
                                <!-- cÃ³digo javascript para cargar la linea del tiempo -->
                                <script src="{% static 'assets/dist/js/map-function-load-timeline.js' %}"></script>
                                <!-- cÃ³digo javascript para gestionar la creacion de los marcadores y sus modales -->
                                <script src="{% static 'assets/dist/js/map-marker-crud-map.js' %}"></script>
                                <!-- cÃ³digo javascript para manejar los eventos en la creacion de los marcadores -->
                                <script src="{% static 'assets/dist/js/map-marker-event-map.js' %}"></script>
                                <!-- cÃ³digo javascript para mejorar la visualizacion de las etiquetas -->
                                <script src="{% static 'assets/dist/js/map-label-improve.js' %}"></script>


                                <!-- Capa de marcadores por defecto apagada -->
                                <script>
                                    markerLayer.remove();

                                    // Carga los eventos del Api
                                    fetchEventsFromAPI();
                                </script>

                                <!-- Este es el archivo que tiene la llamada a la funciÃ³n eqfeed_callback -->
                                <!-- y tiene como parÃ¡metro varios de los vectores que conforman la lÃ­nea del tiempo -->
                                <!-- los cuÃ¡les son: el hielo, la tierra que emerge y las trayectorias de las migraciones-->
                                <script src="{% static 'assets/dist/Leaflet/Leaflet.timeline/migration-timeline.geojsonp' %}"></script>
                                <script>
                                    // SegÃºn la documentaciÃ³n oficial exacta
                                    document.addEventListener('DOMContentLoaded', function () {
                                        console.log('=== INICIALIZANDO TOUR COMPLETO ===');

                                        setTimeout(function () {
                                            try {
                                                // Enfoque de la documentaciÃ³n oficial
                                                const driverObj = window.driver.js.driver({
                                                    popoverClass: 'driverjs-theme',
                                                    showProgress: true,
                                                    animate: true,
                                                    overlayOpacity: 0.7,
                                                    smoothScroll: false,
                                                    allowClose: true,
                                                    stagePadding: 10,
                                                    stageRadius: 5
                                                });

                                                // Definir todos los pasos del tour
                                                const steps = [
                                                    {
                                                        element: '#map',
                                                        popover: {
                                                            title: 'ðºï¸ Principal Map',
                                                            description: 'This is the interactive map that visualizes all human migrations and the spread of CYP2D6 alleles over time and space. You can zoom in with the mouse wheel and drag to navigate through different regions.',
                                                            side: "bottom",
                                                            align: 'center'
                                                        }
                                                    },
                                                    {
                                                        element: '#regionTimeLine',
                                                        popover: {
                                                            title: 'ð Filter by Region',
                                                            description: 'Select a specific geographic region to filter the migrations displayed on the map. By default, all world regions are shown. Options include Africa, Asia, Europe, the Americas, and more.',
                                                            side: "left",
                                                            align: 'start'
                                                        }
                                                    },
                                                    {
                                                        element: '#btreload',
                                                        popover: {
                                                            title: 'ð Load Data',
                                                            description: 'After selecting the desired filters, click here to apply the changes and load the corresponding data onto the map. This will update the display with the selected region and time period.',
                                                            side: "bottom",
                                                            align: 'center'
                                                        }
                                                    },
                                                    {
                                                        element: '#timeRange',
                                                        popover: {
                                                            title: 'â° Time Range',
                                                            description: 'Select different historical periods to visualize specific migrations. Includes migrations of Homo sapiens, Homo erectus, Heidelbergensis, and specific climate periods such as the Last Glacial Maximum.',
                                                            side: "bottom",
                                                            align: 'center'
                                                        }
                                                    },
                                                    {
                                                        element: '#toggleTimeRangePanel',
                                                        popover: {
                                                            title: 'ð Time Range Panel',
                                                            description: 'Click here to show or hide the side panel with additional time range options. Useful for quickly accessing different preconfigured periods.',
                                                            side: "left",
                                                            align: 'start'
                                                        }
                                                    },
                                                    {
                                                        element: '#toggleLegendPanel',
                                                        popover: {
                                                            title: 'ð Map Legend',
                                                            description: 'Open and close the legend panel to understand the meaning of the different symbols, colors, and icons used on the map. It includes information on human species, event types, and population density.',
                                                            side: "left",
                                                            align: 'start'
                                                        }
                                                    },
                                                    {
                                                        element: '#toggleWalking',
                                                        popover: {
                                                            title: 'ð£ Migration List',
                                                            description: 'Show or hide the side panel with the complete chronological list of all CYP2D6 allele migrations and expansions. Allows you to quickly navigate between different migration events.',
                                                            side: "left",
                                                            align: 'start'
                                                        }
                                                    },
                                                    {
                                                        element: '.map-container',
                                                        popover: {
                                                            title: 'ð¯ Map Interaction',
                                                            description: 'You can click on any marker on the map to see specific event details. Different colors and symbols represent different types of migrations and genetic expansion events.',
                                                            side: "mid-center",
                                                            align: 'center'
                                                        }
                                                    },
                                                    {
                                                        element: '#startTourBtn',
                                                        popover: {
                                                            title: 'â Help and Suport',
                                                            description: 'You can always restart this guided tour by clicking this button if you need a refresher on available features or have questions about how to use the app.',
                                                            side: "bottom",
                                                            align: 'center'
                                                        }
                                                    }
                                                ];

                                                // Configurar botÃ³n de inicio del tour
                                                const startBtn = document.getElementById('startTourBtn');
                                                if (startBtn) {
                                                    startBtn.addEventListener('click', () => {
                                                        driverObj.setSteps(steps);
                                                        driverObj.drive();
                                                    });
                                                    console.log('â BotÃ³n de tour configurado');
                                                }

                                                // Auto-inicio en primera visita
                                                if (!sessionStorage.getItem('driverTourShown')) {
                                                    setTimeout(() => {
                                                        driverObj.setSteps(steps);
                                                        driverObj.drive();
                                                        sessionStorage.setItem('driverTourShown', 'true');
                                                        console.log('â Tour automÃ¡tico iniciado');
                                                    }, 3000);
                                                }

                                            } catch (error) {
                                                console.error('Error con driver.js.driver:', error);
                                                tryAlternativeApproach();
                                            }
                                        }, 1000);
                                    });

                                    function tryAlternativeApproach() {
                                        console.log('Probando enfoque alternativo...');

                                        // Intentar diferentes formas
                                        const drivers = [
                                            () => window.driver?.(),
                                            () => window.driver?.js?.driver?.(),
                                            () => window.driverjs?.driver?.()
                                        ];

                                        for (let i = 0; i < drivers.length; i++) {
                                            try {
                                                const driverObj = drivers[i]();
                                                if (driverObj) {
                                                    console.log(`â Driver inicializado con enfoque ${i + 1}`);
                                                    setupTour(driverObj);
                                                    return;
                                                }
                                            } catch (e) {
                                                console.log(`â Enfoque ${i + 1} fallÃ³:`, e.message);
                                            }
                                        }

                                        console.error('â Todos los enfoques fallaron');
                                    }

                                    function setupTour(driverObj) {
                                        // Definir todos los pasos del tour (misma estructura que arriba)
                                        const steps = [
                                            {
                                                element: '#map',
                                                popover: {
                                                    title: 'ðºï¸ Mapa Principal',
                                                    description: 'Este es el mapa interactivo donde se visualizan todas las migraciones humanas y la expansiÃ³n de los alelos CYP2D6.',
                                                    side: "bottom",
                                                    align: 'center'
                                                }
                                            },
                                            {
                                                element: '#regionTimeLine',
                                                popover: {
                                                    title: 'ð Filtro por RegiÃ³n',
                                                    description: 'Selecciona una regiÃ³n geogrÃ¡fica especÃ­fica para filtrar las migraciones.',
                                                    side: "left",
                                                    align: 'start'
                                                }
                                            },
                                            {
                                                element: '#btreload',
                                                popover: {
                                                    title: 'ð Cargar Datos',
                                                    description: 'Haz clic aquÃ­ para aplicar los filtros seleccionados.',
                                                    side: "bottom",
                                                    align: 'center'
                                                }
                                            },
                                            {
                                                element: '#timeRange',
                                                popover: {
                                                    title: 'â° Rango de Tiempo',
                                                    description: 'Selecciona diferentes perÃ­odos histÃ³ricos para visualizar migraciones especÃ­ficas.',
                                                    side: "bottom",
                                                    align: 'center'
                                                }
                                            },
                                            {
                                                element: '#toggleTimeRangePanel',
                                                popover: {
                                                    title: 'ð Panel de Rangos',
                                                    description: 'Muestra/oculta panel lateral con opciones de tiempo.',
                                                    side: "left",
                                                    align: 'start'
                                                }
                                            },
                                            {
                                                element: '#toggleLegendPanel',
                                                popover: {
                                                    title: 'ð Leyenda',
                                                    description: 'Abre/cierra el panel de leyenda del mapa.',
                                                    side: "left",
                                                    align: 'start'
                                                }
                                            },
                                            {
                                                element: '#toggleWalking',
                                                popover: {
                                                    title: 'ð£ Lista de Migraciones',
                                                    description: 'Panel lateral con lista cronolÃ³gica de eventos.',
                                                    side: "left",
                                                    align: 'start'
                                                }
                                            },
                                            {
                                                element: '#startTourBtn',
                                                popover: {
                                                    title: 'â Ayuda',
                                                    description: 'Reinicia este tour cuando lo necesites.',
                                                    side: "bottom",
                                                    align: 'center'
                                                }
                                            }
                                        ];

                                        // Configurar botÃ³n
                                        const startBtn = document.getElementById('startTourBtn');
                                        if (startBtn) {
                                            startBtn.addEventListener('click', () => {
                                                if (driverObj.setSteps) {
                                                    driverObj.setSteps(steps);
                                                    driverObj.drive();
                                                } else if (driverObj.defineSteps) {
                                                    driverObj.defineSteps(steps);
                                                    driverObj.start();
                                                }
                                            });
                                        }

                                        // Auto-inicio
                                        if (!sessionStorage.getItem('tourShown')) {
                                            setTimeout(() => {
                                                if (driverObj.setSteps) {
                                                    driverObj.setSteps(steps);
                                                    driverObj.drive();
                                                } else if (driverObj.defineSteps) {
                                                    driverObj.defineSteps(steps);
                                                    driverObj.start();
                                                }
                                                sessionStorage.setItem('tourShown', 'true');
                                            }, 2000);
                                        }
                                    }
                                </script>

                            </div>
                            <!-- /.card-body -->
                        </div>
                        <!-- /.card -->
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.container-fluid-->
        </section>
    </div>

   



    <!-- Modal que muestra info de los eventos asi como sus imagenes correspondientes -->
    <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Event details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- SecciÃ³n de Nombre -->
                    <h5 class="mt-3 mb-2">Name:</h5>
                    <div id="eventName" class="scrollable mb-4"></div>

                    <!-- SecciÃ³n de DescripciÃ³n -->
                    <h5 class="mt-3 mb-2">Description:</h5>
                    <div id="eventDescription" class="scrollable mb-4"></div>

                    <!-- SecciÃ³n de Referencia -->
                    <h5 class="mt-3 mb-2">Reference:</h5>
                    <a style="cursor: pointer" id="eventReference" class="mb-4"></a>

                    <!-- SecciÃ³n de ImÃ¡genes -->
                    <h5 class="mt-3 mb-2">Event image:</h5>
                    <div id="eventImages" class="d-flex flex-wrap mb-4">

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btnok btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End modal -->


    <!-- Modal que muestra la leyenda -->
    <div class="modal fade" id="legendModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Legend</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img src="{% static 'assets/dist/Leaflet/Leyenda-Short.jpg' %}"
                         alt="Legend"
                         style="height: 500px;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btnok btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End modal -->


{% endblock %}

{% block script %} <!-- DataTables & Plugins -->
    <script src="{% static 'assets/plugins/jquery-validation/jquery.validate.min.js' %}"></script>
    <script src="{% static 'assets/plugins/jquery-validation/additional-methods.min.js' %}"></script>
    <script src="{% static 'assets/plugins/jquery-validation/localization/messages_es.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
{% endblock %}