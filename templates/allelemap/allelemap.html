{% extends "index.html" %} {% load static %} {% block head-extra %}
<link rel="stylesheet" href="{% static 'assets/dist/css/adminlte.min.css' %}" />
<link rel="stylesheet" href="{% static 'assets/dist/css/load.css' %}" />
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/bs-stepper/css/bs-stepper.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/toastr/toastr.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/ion-rangeslider/css/ion.rangeSlider.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/bootstrap-slider/css/bootstrap-slider.min.css' %}"
/>

<link
  rel="stylesheet"
  href="{% static 'assets/plugins/jvectormap/jquery-jvectormap.min.css' %}"
/>

<script src="{% static 'assets/plugins/jvectormap/jquery-1.11.2.min.js' %}"></script>

<script src="{% static 'assets/plugins/jvectormap/jquery-jvectormap.min.js' %}"></script>

<script src="{% static 'assets/plugins/jvectormap/jquery-jvectormap-world-mill-en.js' %}"></script>

<script src="{% static 'assets/plugins/jvectormap/jvectormapAlleleColors.js' %}"></script>

<script src="{% static 'assets/dist/js/3Dmol-min.js' %}"></script>
<script src="{% static 'assets/dist/js/3Dmol.ui-min.js' %}"></script>


{% endblock %} {% block content %}

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header"></section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">

          <div class="card col-12 row">
            <div class="card-header">
              <h3 class="card-title">Allele Map</h3>
              <div class="card-tools">
                <div class="d-inline-block">                  
                  <select class="form-control form-control-sm" name="sampleSize"
                          id="sampleSize" style="width:210px;">
                      <option value="10001-4000000">Sample Size: More Than 10001</option>
                      <option value="1001-10000">Sample Size: 1001-10000</option>
                      <option value="201-1000">Sample Size: 201-1000</option>
                      <option value="101-200">Sample Size: 101-200</option>
                      <option value="51-100">Sample Size: 51-100</option>
                      <option value="1-50">Sample Size: 1-50</option>
                  </select>
                </div>                  
                <div class="d-inline-block">
                  <select class="form-control form-control-sm" name="genes"
                          id="genes" style="width:140px;">
                 <!--     <option value="HLA-A">HLA-A</option>
                      <option value="HLA-B">HLA-B</option>
                      <option value="HLA-C">HLA-C</option>
                      <option value="HLA-DRB1">HLA-DRB1</option>
                      <option value="HLA-DPB1">HLA-DPB1</option>
                      <option value="HLA-DQB1">HLA-DQB1</option>
                      <option value="HLA-DPA1">HLA-DPA1</option>
                      <option value="HLA-DQA1">HLA-DQA1</option>  -->
                  </select>
              </div>

              <div class="d-inline-block">
                  <button class="btnok btn-primary btn-sm border-right" id="btreloadgene">Load
                  </button>
              </div>
                {% comment %} {% endcomment %}
              </div>
            </div>

            <div class="card-body" style= "padding-top: 0.70rem; padding-bottom: 0.70rem; padding-left: 2rem; padding-right: 2rem;">
              <div class="right-sidebar d-flex">
                <div id="map" style="width:1280px; height:590px; position:relative;"></div>
                <div id="tooltipCustom"></div>
              </div>
              </div>
          </div>
        </div>
      </div>     
    </div>
  </section>
  </div>

  <style>
#tooltipCustom {
  position: absolute;
  display: none;
  background: rgba(255,255,255,0.95);
  border: 1px solid #666;
  border-radius: 4px;
  padding: 8px 10px;
  font-size: 13px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  pointer-events: auto;
  z-index: 999999;
  color: black;
  max-width: none;
}

/* Contenedor principal: pastel izquierda, lista derecha */
#tooltipCustom .tooltip-body {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

/* Columna del pastel */
#tooltipCustom .tooltip-pie {
  flex: 0 0 auto;
}

/* Columna de las listas (una o varias columnas de 17) */
#tooltipCustom .allele-columns {
  display: flex;
  gap: 16px;
}

#tooltipCustom .allele-col {
  min-width: 120px;
}

#tooltipCustom .allele-col ul {
  margin: 0;
  padding-left: 16px;
}

#tooltipCustom .allele-col li {
  list-style: none;
}

#tooltipCustom .allele-col li.highlighted {
  font-weight: bold;
  background: rgba(0,0,0,0.05);
}


#tooltipCustom .tooltip-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

#tooltipCustom .tooltip-close {
  cursor: pointer;
  padding: 0 4px;
  font-weight: bold;
}

  </style>
  

  <script>

    if (!sessionStorage.getItem('inicializado')) {
      // Código que solo se ejecuta en la primera carga
      sessionStorage.setItem('gene', 'HLA-A');
      sessionStorage.setItem('minSampleSize', '10000');
      sessionStorage.setItem('maxSampleSize', '4000000');
      sessionStorage.setItem('inicializado', 'true');
    }

 function buildPieSVGForTooltip(parts) {
  const size = 140;
  const cx = size / 2;
  const cy = size / 2;
  const pieRadius = 45;
  const total = parts.reduce((sum, p) => sum + p.value, 0);

  let startAngle = -Math.PI / 2;
  let paths = "";

  parts.forEach((slice, idx) => {
    const sliceAngle = (slice.value / total) * Math.PI * 2;
    const endAngle = startAngle + sliceAngle;

    const x1 = cx + pieRadius * Math.cos(startAngle);
    const y1 = cy + pieRadius * Math.sin(startAngle);
    const x2 = cx + pieRadius * Math.cos(endAngle);
    const y2 = cy + pieRadius * Math.sin(endAngle);
    const large = sliceAngle > Math.PI ? 1 : 0;
    const d = `M${cx},${cy} L${x1},${y1} A${pieRadius},${pieRadius} 0 ${large},1 ${x2},${y2} Z`;

    paths += `
      <path class="pie-slice"
            data-label="${slice.label}"
            d="${d}"
            fill="${slice.color}"
            stroke="rgba(255,255,255,0.9)"
            stroke-width="0.8"></path>`;
    startAngle = endAngle;
  });

  return `
    <svg class="pie-svg-tooltip" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
      ${paths}
    </svg>`;
}

    jQuery(function($) {
    //jQuery(document).ready(function() {
    
    function obtenerColorPorResto(numero) {
    const colores = [
        "#FF0000", // 0
        "#00FF00", // 1
        "#0000FF", // 2
        "#FFFF00", // 3
        "#FF00FF", // 4
        "#00FFFF", // 5
        "#FFA500", // 6
        "#A020F0", // 7
        "#FF7F00", // 8
        "#228B22", // 9
        "#800080", // 10
        "#40E0D0", // 11
        "#DAA520", // 12
        "#4B0082", // 13
        "#FF6F61", // 14
        "#98FF98" // 15
    ];
    // Obtener el resto de la división por 10
    const resto = Math.abs(numero) % 16;
    // Retornar el color correspondiente
    return colores[resto];
}

      const LOADER_DURATION = 18000;
      // 1. Mostrar el loader en cuanto el DOM esté listo.
      Swal.fire({
        title: 'Updating Allele Map Data...',
        html: 'Please wait a few seconds...',
        timer: LOADER_DURATION,
        timerProgressBar: true, // barra de progreso del tiempo
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

    var  gene_name =  sessionStorage.getItem('gene');
    var  min_Sample_Size =  sessionStorage.getItem('minSampleSize');
    var  max_Sample_Size =  sessionStorage.getItem('maxSampleSize');

    $.ajax({
            type: 'GET',
            url: '/allele-mapping/alleles-to-map/genes/',            
            error: function () {
                Swal.fire({
                    icon: "error",
                    title: "No se pudieron cargar los datos.",
                    showConfirmButton: false,
                    timer: 1500
                });
            },
            dataType: 'json',
            success: function (response) {
                var data = response;
                selectGenes = document.getElementById('genes');
                data.forEach(function (genes) {
                  var opt = document.createElement('option');
                  opt.value = genes.name;
                  opt.innerHTML = genes.name;
                  selectGenes.appendChild(opt);
                });
            }
        });

    var mapPoints = [];  
    let regionAllele = {};
    let alleleInfo = {};
      $.ajax({
            type: 'GET',
            url: '/allele-mapping/alleles-region/by-gene/?gene_name='+gene_name+'&min_sample_size='+min_Sample_Size+'&max_sample_size='+max_Sample_Size,            
            //url: '/allele-mapping/alleles-region/by-gene/?gene_name=HLA-A',
            error: function () {
                Swal.fire({
                    icon: "error",
                    title: "No se pudieron cargar los datos.",
                    showConfirmButton: false,
                    timer: 1500
                });
            },
            dataType: 'json',
            success: function (response) {
                //var data = response.results;
                var data = response;

                data.forEach(function (region) {
              
                    regionAlele = {
                        name: region.population,
                        latLng: [region.lat, region.lon],
                      pie: []
                    };
 
                    // Procesar cada marcador del evento
                    region.alleles.forEach(function (allele) {                  
                        alleleInfo = {
                          color: obtenerColorPorResto(allele.id),
                          label: allele.allele_name,
                          value: allele.allele_frequency
                        }

                        regionAlele.pie.push(alleleInfo);
                    });
                    
                    mapPoints.push(regionAlele);

                });

                // Si necesitas manejar el tiempo, puedes usar esto:
                if (data.length > 0 && data[0].start_date) {
                    // Configurar el control de tiempo si es necesario
                    // timeDimension.setCurrentTime(new Date(data[0].start_date));
                }
            }
        }); 
          
setTimeout(function () {

  const $tooltip = $("#tooltipCustom");
  
  function chunkArray(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) {
    chunks.push(arr.slice(i, i + size));
  }
  return chunks;
}

  function createPieGroup(parts, name, index) {
  const size = 50, cx = size / 2, cy = size / 2;
  const pieRadius = 12;
  const total = parts.reduce((sum, p) => sum + p.value, 0);

  const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
  group.dataset.index = index;
  group.style.cursor = "pointer";

  const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
  defs.innerHTML = `
    <filter id="shadow-${index}" x="-20%" y="-20%" width="150%" height="150%">
      <feDropShadow dx="1.5" dy="1.5" stdDeviation="1.2" flood-color="rgba(0,0,0,0.4)" />
    </filter>`;
  group.appendChild(defs);

  let startAngle = -Math.PI / 2;
  parts.forEach(slice => {
    const sliceAngle = (slice.value / total) * Math.PI * 2;
    const endAngle = startAngle + sliceAngle;
    const x1 = cx + pieRadius * Math.cos(startAngle);
    const y1 = cy + pieRadius * Math.sin(startAngle);
    const x2 = cx + pieRadius * Math.cos(endAngle);
    const y2 = cy + pieRadius * Math.sin(endAngle);
    const large = sliceAngle > Math.PI ? 1 : 0;
    const d = `M${cx},${cy} L${x1},${y1} A${pieRadius},${pieRadius} 0 ${large},1 ${x2},${y2} Z`;

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", d);
    path.setAttribute("fill", slice.color);
    path.setAttribute("stroke", "rgba(255,255,255,0.9)");
    path.setAttribute("stroke-width", "0.8");
    path.setAttribute("filter", `url(#shadow-${index})`);
    path.classList.add("pie-slice");
    group.appendChild(path);

    startAngle = endAngle;
  });

  // IMPORTANTE: quitar tooltip por hover y usar solo click
  // Quitar mouseenter/mousemove/mouseleave y usar solo click
  group.addEventListener("click", (e) => {
  e.stopPropagation();
  const $tooltip = $("#tooltipCustom");

  const columns = chunkArray(parts, 17); // tu función para partir el array

  let html = `
    <div class="tooltip-header">
      <b>${name}</b>
      <span class="tooltip-close">&times;</span>
    </div>
    <div class="tooltip-body">
      <div class="tooltip-pie">
        ${buildPieSVGForTooltip(parts)}
      </div>
      <div class="allele-columns">
  `;

  columns.forEach(col => {
    html += `<div class="allele-col"><ul>`;
    col.forEach(p => {
      html += `
        <li data-label="${p.label}">
          <span style="display:inline-block;width:10px;height:10px;background:${p.color};margin-right:5px;"></span>
          ${p.label}: ${p.value.toFixed(4)}%
        </li>`;
    });
    html += `</ul></div>`;
  });

  html += `
      </div> <!-- cierre allele-columns -->
    </div>   <!-- cierre tooltip-body -->
  `;

  $tooltip.html(html).show();

  // Posicionamiento del tooltip (puedes dejar tu código actual)
  const mapOffset = $("#map").offset();
  const mapBox = document.getElementById("map").getBoundingClientRect();
  const gBox = group.getBoundingClientRect();

  const left = mapOffset.left + (gBox.left - mapBox.left);
  const top  = mapOffset.top  + (gBox.top  - mapBox.top) - 5;

  $tooltip.css({ left: left - 40 + "px", top: top - 60 + "px" });

  // Cerrar con la X
  $tooltip.find(".tooltip-close").on("click", function() {
    $tooltip.hide();
  });

  // Hover en cuñas del pastel DEL TOOLTIP para resaltar en la lista
  const $svgTooltip = $tooltip.find('.pie-svg-tooltip');
  $svgTooltip.find('.pie-slice').on('mouseenter', function() {
    const label = $(this).data('label');
    const $lis = $tooltip.find('.allele-col li');
    $lis.removeClass('highlighted');
    $lis.filter(`[data-label="${label}"]`).addClass('highlighted');
  });
  $svgTooltip.find('.pie-slice').on('mouseleave', function() {
    $tooltip.find('.allele-col li').removeClass('highlighted');
  });
});
  return group;
}

$(document).on('click', function(e) {
  if (!$(e.target).closest('#tooltipCustom, #map').length) {
    $("#tooltipCustom").hide();
  }
});
    
      function addPieMarkers(map) {
        const mapObj = $(map).vectorMap('get', 'mapObject');
        const svgRoot = mapObj.canvas.node;
        mapObj.pieMarkers = [];
    
        mapPoints.forEach((pt, i) => {
          mapObj.addMarker(i, { latLng: pt.latLng, name: pt.name }, []);
          const pieGroup = createPieGroup(pt.pie, pt.name, i);
          svgRoot.appendChild(pieGroup);
          mapObj.pieMarkers.push(pieGroup);
        });
    
        reposition(map);
      }
    
      function reposition(map) {
        const mapObj = $(map).vectorMap('get', 'mapObject');
        if (!mapObj.pieMarkers) return;
    
        const markers = mapObj.markers;
        mapPoints.forEach((_, i) => {
          const el = markers[i].element;
          const cx = el.shape.node.getAttribute("cx");
          const cy = el.shape.node.getAttribute("cy");
          const g = mapObj.pieMarkers[i];
          if (!g) return;
          const x = parseFloat(cx) - 20;
          const y = parseFloat(cy) - 20;
          g.setAttribute("transform", `translate(${x},${y})`);
        });
      }
    
      // Inicializa el mapa
      $('#map').vectorMap({
      //$('#map').vectorMap({
        map: 'world_mill_en',
        //backgroundColor: 'aliceblue',
        backgroundColor: '#eff7ff', 
        //regioncolor: '#229922',
        regionStyle: { initial: { fill: '#F3D1A2', stroke: '#d2a679'} },
        markers: mapPoints.map(p => ({ latLng: p.latLng, name: p.name })),
        markerStyle: {
          initial: { r: 8, fill: 'transparent', stroke: 'transparent' },
          hover:   { fill: 'transparent' }
        },
        onViewportChange: () => reposition('#map')
      });
    
      setTimeout(() => addPieMarkers('#map'), 300);

    }, 14000);

    });

    document.getElementById('btreloadgene').addEventListener('click', function() {   

        var aGene = document.getElementById("genes");
        sessionStorage.setItem('gene', aGene.value);

        var aSampleSize = document.getElementById("sampleSize");
        var aPosition = aSampleSize.value.indexOf("-");
        var aBegin = aSampleSize.value.substring(0,aPosition);
        var anEnd = aSampleSize.value.substring(aPosition+1);

        sessionStorage.setItem('minSampleSize', parseInt(aBegin));
        sessionStorage.setItem('maxSampleSize', parseInt(anEnd));
                                         
        // se manda a recargar toda la página para actualizar la línea del tiempo con los cambios en los marcadores
        setTimeout(function () {
        location.reload()
        }, 500);
    });    

    </script>  
    <!-- /.card-body -->

{% endblock %} 
{% block script %}
<!-- DataTables & Plugins -->
<script src="{% static 'assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>

<script src="{% static 'assets/plugins/pdfmake/vfs_fonts.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
<script src="{% static 'assets/plugins/bs-custom-file-input/bs-custom-file-input.min.js' %}"></script>
<script src="{% static 'assets/plugins/jquery-validation/jquery.validate.min.js' %}"></script>
<script src="{% static 'assets/plugins/jquery-validation/additional-methods.min.js' %}"></script>
<script src="{% static 'assets/plugins/jquery-validation/localization/messages_es.js' %}"></script>
<script src="{% static 'assets/plugins/toastr/toastr.min.js' %}"></script>
<script src="{% static 'assets/plugins/bs-stepper/js/bs-stepper.min.js' %}"></script>
<script src="{% static 'assets/plugins/ion-rangeslider/js/ion.rangeSlider.min.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap-slider/bootstrap-slider.min.js' %}"></script>
<script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>

{% comment %}  {% endcomment %}

{% endblock %}
