{% extends "index.html" %} {% load static %} {% block head-extra %}
<link rel="stylesheet" href="{% static 'assets/dist/css/adminlte.min.css' %}" />
<link rel="stylesheet" href="{% static 'assets/dist/css/load.css' %}" />
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/bs-stepper/css/bs-stepper.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/toastr/toastr.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/ion-rangeslider/css/ion.rangeSlider.min.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'assets/plugins/bootstrap-slider/css/bootstrap-slider.min.css' %}"
/>

<link
  rel="stylesheet"
  href="{% static 'assets/plugins/jvectormap/jquery-jvectormap.min.css' %}"
/>

<script src="{% static 'assets/plugins/jvectormap/jquery-1.11.2.min.js' %}"></script>

<script src="{% static 'assets/plugins/jvectormap/jquery-jvectormap.min.js' %}"></script>

<script src="{% static 'assets/plugins/jvectormap/jquery-jvectormap-world-mill-en.js' %}"></script>

<script src="{% static 'assets/plugins/jvectormap/jvectormapAlleleColors.js' %}"></script>

<script src="{% static 'assets/dist/js/3Dmol-min.js' %}"></script>
<script src="{% static 'assets/dist/js/3Dmol.ui-min.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>


{% endblock %} {% block content %}

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header"></section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">

          <div class="card col-12 row">
            <div class="card-header">
              <h3 class="card-title">Allele Map</h3>
              <div class="card-tools">
                <div class="d-inline-block">
                  <select class="form-control form-control-sm" name="sampleSize"
                          id="sampleSize" style="width:210px;">
                      <option value="10001-4000000">Sample Size: More Than 10001</option>
                      <option value="1001-10000">Sample Size: 1001-10000</option>
                      <option value="201-1000">Sample Size: 201-1000</option>
                      <option value="101-200">Sample Size: 101-200</option>
                      <option value="51-100">Sample Size: 51-100</option>
                      <option value="1-50">Sample Size: 1-50</option>
                  </select>
                </div>
                <div class="d-inline-block">
                  <select class="form-control form-control-sm" name="genes"
                          id="genes" style="width:140px;">
                 <!--     <option value="HLA-A">HLA-A</option>
                      <option value="HLA-B">HLA-B</option>
                      <option value="HLA-C">HLA-C</option>
                      <option value="HLA-DRB1">HLA-DRB1</option>
                      <option value="HLA-DPB1">HLA-DPB1</option>
                      <option value="HLA-DQB1">HLA-DQB1</option>
                      <option value="HLA-DPA1">HLA-DPA1</option>
                      <option value="HLA-DQA1">HLA-DQA1</option>  -->
                  </select>
              </div>
              <div class="d-inline-block">
                <select class="form-control form-control-sm" name="allelic_group"
                        id="allelic_group" style="width:140px;">
                </select>
            </div>

              <div class="d-inline-block">
                  <button class="btnok btn-primary btn-sm border-right" id="btreloadgene">Load
                  </button>
              </div>
                {% comment %} {% endcomment %}
              </div>
            </div>

            <div class="card-body" style= "padding-top: 0.70rem; padding-bottom: 0.70rem; padding-left: 2rem; padding-right: 2rem;">
              <div class="right-sidebar d-flex">
                <div id="map" style="width:1280px; height:590px; position:relative;"></div>
              </div>
              </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  </div>

<!-- Modal para mostrar la información de los alelos -->
  <div class="modal fade" id="alleleModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row">
              <div class="col-md-5">
                <div id="modalPieChart"></div>
              </div>
              <div class="col-md-7">
                <div id="alleleColumns" class="row"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <style>
/* Estilos para las columnas de alelos en el modal */
.allele-col {
  min-width: 150px;
  margin-bottom: 10px;
}

.allele-col ul {
  margin: 0;
  padding-left: 20px;
}

.allele-col li {
  list-style: none;
  padding: 2px 5px;
  font-size: 0.85rem;
}

.allele-col li.highlighted {
  font-weight: bold;
  background-color: #e8f4f8;
  border-radius: 3px;
}

/* Estilo para el gráfico de pastel en el modal */
.pie-slice {
  cursor: pointer;
  transition: opacity 0.2s;
}

.pie-slice:hover {
  opacity: 0.8;
}
  </style>


<script>

    if (!sessionStorage.getItem('inicializado')) {
      sessionStorage.setItem('gene', 'HLA-A');
      sessionStorage.setItem('group_allele', 'A*01');
      sessionStorage.setItem('minSampleSize', '10000');
      sessionStorage.setItem('maxSampleSize', '4000000');
      sessionStorage.setItem('inicializado', 'true');
    }

function buildPieSVGForModal(parts, size = 200) {
  const cx = size / 2;
  const cy = size / 2;
  const pieRadius = (size * 0.35);
  const total = parts.reduce((sum, p) => sum + p.value, 0);

  let startAngle = -Math.PI / 2;
  let paths = "";

  parts.forEach((slice, idx) => {
    const sliceAngle = (slice.value / total) * Math.PI * 2;
    const endAngle = startAngle + sliceAngle;

    const x1 = cx + pieRadius * Math.cos(startAngle);
    const y1 = cy + pieRadius * Math.sin(startAngle);
    const x2 = cx + pieRadius * Math.cos(endAngle);
    const y2 = cy + pieRadius * Math.sin(endAngle);
    const large = sliceAngle > Math.PI ? 1 : 0;
    const d = `M${cx},${cy} L${x1},${y1} A${pieRadius},${pieRadius} 0 ${large},1 ${x2},${y2} Z`;

    paths += `
      <path class="pie-slice"
            data-label="${slice.label}"
            d="${d}"
            fill="${slice.color}"
            stroke="rgba(255,255,255,0.9)"
            stroke-width="1.5"
            style="cursor: pointer;"></path>`;
    startAngle = endAngle;
  });

  return `
    <svg class="pie-svg-modal" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
      ${paths}
    </svg>`;
}

    jQuery(function($) {
    
    function obtenerColorPorResto(numero) {
    const colores = [
        "#FF0000", // 0
        "#00FF00", // 1
        "#0000FF", // 2
        "#FFFF00", // 3
        "#FF00FF", // 4
        "#00FFFF", // 5
        "#FFA500", // 6
        "#A020F0", // 7
        "#FF7F00", // 8
        "#228B22", // 9
        "#800080", // 10
        "#40E0D0", // 11
        "#DAA520", // 12
        "#4B0082", // 13
        "#FF6F61", // 14
        "#98FF98" // 15
    ];
    const resto = Math.abs(numero) % 16;
    return colores[resto];
}


function buildOffsets() {
  const offsets = [];
  const ds = [1, 2, 3]; // puedes ampliar si algún día necesitas más

  for (const d of ds) {
    offsets.push(
      [ d,  0],  // +d lat,  0 lon
      [-d,  0],  // -d lat,  0 lon
      [ 0,  d],  //  0 lat, +d lon
      [ 0, -d],  //  0 lat, -d lon
      [ d,  d],  // +d lat, +d lon
      [ d, -d],  // +d lat, -d lon
      [-d,  d],  // -d lat, +d lon
      [-d, -d],  // -d lat, -d lon
    );
  }

  return offsets;
}

const OFFSETS = buildOffsets();

// Convierte una coordenada en clave de Set/Map
function coordKey(lat, lon) {
  // Si quieres controlar el redondeo usa toFixed
  return `${lat},${lon}`;
}

/**
 * Ajusta las coordenadas de `element` para que no repita (lat, lon) en MapPoint,
 * siguiendo el patrón de offsets descrito.
 *
 * MapPoint: array de objetos { id, population, location, latLng: [lat, lon], ... }
 * element: objeto a insertar, con latLng: [lat, lon]
 */
 function adjustLatLngForNewElement(MapPoint, element) {
  if (!element.latLng || element.latLng.length !== 2) {
    throw new Error("element.latLng debe ser un array [lat, lon]");
  }

  let [baseLat, baseLon] = element.latLng;

  // Construimos el conjunto de coordenadas ya usadas
  const used = new Set(
    MapPoint
      .filter(p => Array.isArray(p.latLng) && p.latLng.length === 2)
      .map(p => coordKey(p.latLng[0], p.latLng[1]))
  );

  // Si no está usada, no hay nada que hacer
  if (!used.has(coordKey(baseLat, baseLon))) {
    return element; // sin cambios
  }

  // Buscamos la primera combinación libre siguiendo el patrón
  let newLat = baseLat;
  let newLon = baseLon;
  let found = false;

  for (const [dLat, dLon] of OFFSETS) {
    const candLat = baseLat + dLat;
    const candLon = baseLon + dLon;
    const key = coordKey(candLat, candLon);

    if (!used.has(key)) {
      newLat = candLat;
      newLon = candLon;
      found = true;
      break;
    }
  }

  if (!found) {
    // Opcional: si quieres un fallback más allá de 3 grados:
    // por ejemplo seguir creciendo d = 4,5,6...
    // o lanzar un error porque dices que no habrá > 25 coincidencias.
    console.warn("No se encontró posición libre dentro de ±3 grados para", baseLat, baseLon);
  }

  element.latLng = [newLat, newLon];
  return element;
}

      const LOADER_DURATION = 18000;
      Swal.fire({
        title: 'Updating Allele Map Data...',
        html: 'Please wait a few seconds...',
        timer: LOADER_DURATION,
        timerProgressBar: true,
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

    var  gene_name =  sessionStorage.getItem('gene');
    var  group_allele =   sessionStorage.getItem('group_allele');
    var  min_Sample_Size =  sessionStorage.getItem('minSampleSize');
    var  max_Sample_Size =  sessionStorage.getItem('maxSampleSize');

    $.ajax({
            type: 'GET',
            url: '/business-gestion/gene/with-alleles-to-map/',            
            error: function () {
                Swal.fire({
                    icon: "error",
                    title: "No se pudieron cargar los datos.",
                    showConfirmButton: false,
                    timer: 1500
                });
            },
            dataType: 'json',
            success: function (response) {
                var data = response;
                selectGenes = document.getElementById('genes');
                data.forEach(function (genes) {
                  var opt = document.createElement('option');
                  opt.value = genes.name;
                  opt.innerHTML = genes.name;
                  selectGenes.appendChild(opt);
                });
                var aGene = document.getElementById("genes");
                aGene.value = sessionStorage.getItem('gene');      
            }
        });

    LoadAlleleGroup();

    function LoadAlleleGroup() {
        $.ajax({
            type: 'GET',
            url: '/business-gestion/gene/allelic-groups/?gene_name='+gene_name,            
            error: function () {
                Swal.fire({
                    icon: "error",
                    title: "No se pudieron cargar los datos.",
                    showConfirmButton: false,
                    timer: 1500
                });
            },
            dataType: 'json',
            success: function (response) {
                var data = response;
                selectGroupAllele = document.getElementById('allelic_group');
                data.allelic_groups.forEach(function (alele_group) {
                  var opt = document.createElement('option');
                  opt.value = alele_group;
                  opt.innerHTML = alele_group;
                  selectGroupAllele.appendChild(opt);
                });
                var aAllele_Group = document.getElementById("allelic_group");
                aAllele_Group.value = sessionStorage.getItem("group_allele");      
            }
        }); 
    };       


    var mapPoints = [];  
    let regionAlele = {};
    let alleleInfo = {};
      $.ajax({
            type: 'GET',
            url: '/allele-mapping/alleles-region/by-gene/?allelic_group='+group_allele+'&min_sample_size='+min_Sample_Size+'&max_sample_size='+max_Sample_Size,            
            error: function () {
                Swal.fire({
                    icon: "error",
                    title: "No se pudieron cargar los datos.",
                    showConfirmButton: false,
                    timer: 1500
                });
            },
            dataType: 'json',
            success: function (response) {
                var data = response;

                data.forEach(function (region) {
                    regionAlele = {
                        name: region.population,
                        latLng: [region.lat, region.lon],
                        pie: []
                    };

                    region.alleles.forEach(function (allele) {                  
                        alleleInfo = {
                          color: obtenerColorPorResto(allele.id),
                          label: allele.allele_name,
                          value: allele.allele_frequency
                        }
                        regionAlele.pie.push(alleleInfo);
                    });
                    
                    regionAlele = adjustLatLngForNewElement(mapPoints, regionAlele)

                    mapPoints.push(regionAlele);
                });
            }
        }); 
          
setTimeout(function () {

  // Función para dividir el array en columnas
  function chunkArray(arr, size) {
    const chunks = [];
    for (let i = 0; i < arr.length; i += size) {
      chunks.push(arr.slice(i, i + size));
    }
    return chunks;
  }

  // Función para mostrar el modal con la información
  function showModal(name, parts) {
    const columns = chunkArray(parts, 17);
    
    // Actualizar título del modal
    $('#modalTitle').text(name);
    
    // Construir gráfico de pastel
    $('#modalPieChart').html(buildPieSVGForModal(parts));
    
    // Construir columnas de alelos
    let columnsHTML = '';
    columns.forEach((col, colIndex) => {
      columnsHTML += `<div class="col-md-6 allele-col">`;
      columnsHTML += `<ul>`;
      col.forEach(p => {
        columnsHTML += `
          <li data-label="${p.label}">
            <span style="display:inline-block;width:12px;height:12px;background:${p.color};margin-right:8px;border-radius:2px;"></span>
            <strong>${p.label}:</strong> ${p.value.toFixed(2)}%
          </li>`;
      });
      columnsHTML += `</ul></div>`;
    });
    
    $('#alleleColumns').html(columnsHTML);
    
    // Agregar eventos hover a las porciones del pastel
    $('#modalPieChart .pie-slice').on('mouseenter', function() {
      const label = $(this).data('label');
      $('#alleleColumns li').removeClass('highlighted');
      $(`#alleleColumns li[data-label="${label}"]`).addClass('highlighted');
    }).on('mouseleave', function() {
      $('#alleleColumns li').removeClass('highlighted');
    });
    
    // Mostrar el modal
    $('#alleleModal').modal('show');
  }

  function createPieGroup(parts, name, index) {
    const size = 50, cx = size / 2, cy = size / 2;
    const pieRadius = 12;
    const total = parts.reduce((sum, p) => sum + p.value, 0);

    const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
    group.dataset.index = index;
    group.style.cursor = "pointer";

    const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
    defs.innerHTML = `
      <filter id="shadow-${index}" x="-20%" y="-20%" width="150%" height="150%">
        <feDropShadow dx="1.5" dy="1.5" stdDeviation="1.2" flood-color="rgba(0,0,0,0.4)" />
      </filter>`;
    group.appendChild(defs);

    let startAngle = -Math.PI / 2;
    parts.forEach(slice => {
      const sliceAngle = (slice.value / total) * Math.PI * 2;
      const endAngle = startAngle + sliceAngle;
      const x1 = cx + pieRadius * Math.cos(startAngle);
      const y1 = cy + pieRadius * Math.sin(startAngle);
      const x2 = cx + pieRadius * Math.cos(endAngle);
      const y2 = cy + pieRadius * Math.sin(endAngle);
      const large = sliceAngle > Math.PI ? 1 : 0;
      const d = `M${cx},${cy} L${x1},${y1} A${pieRadius},${pieRadius} 0 ${large},1 ${x2},${y2} Z`;

      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", d);
      path.setAttribute("fill", slice.color);
      path.setAttribute("stroke", "rgba(255,255,255,0.9)");
      path.setAttribute("stroke-width", "0.8");
      path.setAttribute("filter", `url(#shadow-${index})`);
      path.classList.add("pie-slice");
      group.appendChild(path);

      startAngle = endAngle;
    });

    // Evento click para mostrar el modal
    group.addEventListener("click", (e) => {
      e.stopPropagation();
      showModal(name, parts);
    });
    
    return group;
  }

  function addPieMarkers(map) {
    const mapObj = $(map).vectorMap('get', 'mapObject');
    const svgRoot = mapObj.canvas.node;
    mapObj.pieMarkers = [];

    mapPoints.forEach((pt, i) => {
      mapObj.addMarker(i, { latLng: pt.latLng, name: pt.name }, []);
      const pieGroup = createPieGroup(pt.pie, pt.name, i);
      svgRoot.appendChild(pieGroup);
      mapObj.pieMarkers.push(pieGroup);
    });

    reposition(map);
  }

  function reposition(map) {
    const mapObj = $(map).vectorMap('get', 'mapObject');
    if (!mapObj.pieMarkers) return;

    const markers = mapObj.markers;
    mapPoints.forEach((_, i) => {
      const el = markers[i].element;
      const cx = el.shape.node.getAttribute("cx");
      const cy = el.shape.node.getAttribute("cy");
      const g = mapObj.pieMarkers[i];
      if (!g) return;
      const x = parseFloat(cx) - 20;
      const y = parseFloat(cy) - 20;
      g.setAttribute("transform", `translate(${x},${y})`);
    });
  }

  // Inicializa el mapa
  $('#map').vectorMap({
    map: 'world_mill_en',
    backgroundColor: '#eff7ff', 
    regionStyle: { initial: { fill: '#F3D1A2', stroke: '#d2a679'} },
    markers: mapPoints.map(p => ({ latLng: p.latLng, name: p.name })),
    markerStyle: {
      initial: { r: 8, fill: 'transparent', stroke: 'transparent' },
      hover:   { fill: 'transparent' }
    },
    onViewportChange: () => reposition('#map')
  });

  setTimeout(() => addPieMarkers('#map'), 300);

}, 14000);

});

document.getElementById('btreloadgene').addEventListener('click', function() {   
    var aGene = document.getElementById("genes");
    sessionStorage.setItem('gene', aGene.value);

    var aGroupAllele = document.getElementById("allelic_group");
    sessionStorage.setItem('group_allele', aGroupAllele.value);

    var aSampleSize = document.getElementById("sampleSize");
    var aPosition = aSampleSize.value.indexOf("-");
    var aBegin = aSampleSize.value.substring(0,aPosition);
    var anEnd = aSampleSize.value.substring(aPosition+1);

    sessionStorage.setItem('minSampleSize', parseInt(aBegin));
    sessionStorage.setItem('maxSampleSize', parseInt(anEnd));
                                     
    setTimeout(function () {
    location.reload()
    }, 500);
});    

document.getElementById('genes').addEventListener('onchange', function() {   
 LoadAlleleGroup();                                     
    setTimeout(function () {
    location.reload()
    }, 500);
});   

</script>
    <!-- /.card-body -->

{% endblock %}
{% block script %}
<!-- DataTables & Plugins -->
<script src="{% static 'assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>

<script src="{% static 'assets/plugins/pdfmake/vfs_fonts.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
<script src="{% static 'assets/plugins/bs-custom-file-input/bs-custom-file-input.min.js' %}"></script>
<script src="{% static 'assets/plugins/jquery-validation/jquery.validate.min.js' %}"></script>
<script src="{% static 'assets/plugins/jquery-validation/additional-methods.min.js' %}"></script>
<script src="{% static 'assets/plugins/jquery-validation/localization/messages_es.js' %}"></script>
<script src="{% static 'assets/plugins/toastr/toastr.min.js' %}"></script>
<script src="{% static 'assets/plugins/bs-stepper/js/bs-stepper.min.js' %}"></script>
<script src="{% static 'assets/plugins/ion-rangeslider/js/ion.rangeSlider.min.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap-slider/bootstrap-slider.min.js' %}"></script>
<script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>



{% endblock %}